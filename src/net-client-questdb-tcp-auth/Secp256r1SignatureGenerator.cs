using Org.BouncyCastle.Asn1.Sec;
using Org.BouncyCastle.Crypto.Parameters;
using Org.BouncyCastle.Math;
using Org.BouncyCastle.Security;

namespace QuestDB;

public class Secp256r1SignatureGenerator : ISignatureGenerator
{
    public byte[] GenerateSignature(byte[] privateKey, byte[] buffer, int bufferLen)
    {
        var p = SecNamedCurves.GetByName("secp256r1");
        var parameters = new ECDomainParameters(p.Curve, p.G, p.N, p.H);
        var priKey = new ECPrivateKeyParameters(
            "ECDSA",
            new BigInteger(1, privateKey), // d
            parameters);

        var ecdsa = SignerUtilities.GetSigner("SHA-256withECDSA");
        ecdsa.Init(true, priKey);
        ecdsa.BlockUpdate(buffer, 0, bufferLen);
        var signature = ecdsa.GenerateSignature();
        return signature;
    }
}